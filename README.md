# 政策咨询智能体POC系统文档

## 1. 系统概述

### 1.1 项目简介
政策咨询智能体POC是一个基于大语言模型的智能政策咨询系统，旨在为用户提供精准的政策咨询建议。系统集成了DeepSeek V3模型，通过LangChain框架实现智能对话和场景化政策推荐。

### 1.2 核心功能
- **智能对话**：基于LLM的自然语言交互
- **场景化咨询**：支持四种标准场景的精准咨询
- **政策匹配**：基于意图识别和实体提取的政策检索
- **结构化回答**：生成包含肯定、否定和建议的结构化回复
- **性能监控**：实时追踪LLM调用时间和系统响应时间
- **缓存机制**：提升重复查询的响应速度
- **会话管理**：支持多会话历史记录
- **岗位推荐**：基于用户画像和技能的个性化岗位推荐
- **课程推荐**：基于用户需求的培训课程智能匹配
- **用户画像**：支持用户画像创建和管理

### 1.3 应用场景
1. 创业扶持政策精准咨询
2. 技能培训岗位个性化推荐
3. 多重政策叠加咨询
4. 培训课程智能匹配

## 2. 系统架构

### 2.1 整体架构
```
┌─────────────────────────────────────────────────────────────┐
│                        用户界面层                            │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐     │
│  │  场景选择    │  │  对话交互    │  │  结果展示    │     │
│  └──────────────┘  └──────────────┘  └──────────────┘     │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                        API服务层                            │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐     │
│  │  /api/chat   │  │/api/policies │  │/api/evaluate │     │
│  └──────────────┘  └──────────────┘  └──────────────┘     │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                      业务逻辑层                              │
│  ┌──────────────────────────────────────────────────────┐  │
│  │              PolicyAgent（政策智能体）                 │  │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐          │  │
│  │  │意图识别  │  │政策检索  │  │回答生成  │          │  │
│  │  └──────────┘  └──────────┘  └──────────┘          │  │
│  └──────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                      LLM集成层                               │
│  ┌──────────────────────────────────────────────────────┐  │
│  │              ChatBot（对话机器人）                    │  │
│  │  ┌──────────────────────────────────────────────┐  │  │
│  │  │        DeepSeek V3（火山引擎）                │  │  │
│  │  └──────────────────────────────────────────────┘  │  │
│  └──────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                      数据层                                   │
│  ┌──────────────────────────────────────────────────────┐  │
│  │              policies.json（政策数据）                │  │
│  └──────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
```

### 2.2 目录结构
```
政策咨询POC/
├── code/                        # 核心代码目录
│   ├── langchain/              # LangChain业务逻辑
│   │   ├── __init__.py
│   │   ├── chatbot.py          # LLM对话集成
│   │   ├── policy_agent.py     # 政策智能体核心逻辑
│   │   ├── history_manager.py  # 会话历史管理
│   │   ├── job_matcher.py      # 岗位匹配器
│   │   ├── course_matcher.py   # 课程匹配器
│   │   ├── user_profile.py     # 用户画像管理
│   │   └── data/               # 数据文件
│   │       ├── jobs.json       # 岗位数据
│   │       ├── courses.json    # 课程数据
│   │       ├── policies.json   # 政策数据
│   │       └── user_profiles.json # 用户画像数据
│   ├── serve_code/             # 后端API服务
│   │   ├── main.py             # FastAPI主程序
│   │   ├── requirements.txt    # Python依赖
│   │   ├── test_scenario1.py   # 场景1测试脚本
│   │   └── test_scenario2.py   # 场景2测试脚本
│   └── web_code/               # 前端界面
│       ├── index.html          # 主页面
│       ├── app.js              # 前端逻辑
│       └── style.css           # 样式文件
├── doc/                        # 文档目录
├── .env                        # 环境变量配置（本地开发）
├── .gitignore                  # Git忽略文件
├── main.py                     # Vercel部署入口
├── package.json                # 项目配置
├── requirements.txt            # 根目录依赖（Vercel部署）
└── vercel.json                 # Vercel部署配置
```

## 3. 技术栈

### 3.1 后端技术
| 技术 | 版本 | 用途 |
|------|------|------|
| Python | 3.12+ | 开发语言 |
| FastAPI | Latest | Web框架 |
| LangChain | Latest | LLM应用框架 |
| LangChain-OpenAI | Latest | OpenAI兼容API集成 |
| python-dotenv | Latest | 环境变量管理 |
| Pydantic | Latest | 数据验证 |
| Uvicorn | Latest | ASGI服务器 |
| Mangum | Latest | AWS Lambda适配器（Vercel部署） |

### 3.2 前端技术
| 技术 | 用途 |
|------|------|
| HTML5 | 页面结构 |
| CSS3 | 样式设计 |
| JavaScript (ES6+) | 交互逻辑 |
| Fetch API | HTTP请求 |

### 3.3 LLM服务
| 服务 | 模型 | 用途 |
|------|------|------|
| 火山引擎 | DeepSeek V3 | 大语言模型 |

## 4. 核心模块详解

### 4.1 ChatBot模块 ([chatbot.py](file:///Users/tianyong/Documents/works/workspace/hp/公司文档/AI调研/政策咨询POC/code/langchain/chatbot.py))

#### 功能描述
负责与DeepSeek V3模型的集成，提供对话记忆和LLM调用功能。

#### 核心方法
```python
def chat_with_memory(self, user_input):
    """带记忆的对话，返回内容和调用时间"""
    # 输入截断处理
    # 添加到对话记忆
    # 限制历史消息数量
    # LLM调用
    # 记录调用时间
    # 返回结果
```

#### 性能优化
- **输入截断**：超过2000字符自动截断
- **历史限制**：只保留最近10条消息
- **简化消息格式**：使用HumanMessage减少上下文长度
- **超时设置**：1800秒超时保护
- **Token限制**：最大8192 tokens

### 4.2 PolicyAgent模块 ([policy_agent.py](file:///Users/tianyong/Documents/works/workspace/hp/公司文档/AI调研/政策咨询POC/code/langchain/policy_agent.py))

#### 功能描述
政策智能体核心逻辑，负责意图识别、政策检索和回答生成。

#### 核心流程
```python
def process_query(self, user_input):
    """处理用户查询的完整流程"""
    # 1. 检查缓存
    # 2. 合并处理（意图识别 + 回答生成）
    # 3. 评估结果
    # 4. 添加计时信息
    # 5. 缓存结果
    # 6. 返回结果
```

#### 意图识别
- 基于LLM的意图识别和实体提取
- 支持多种政策咨询场景的意图识别

#### 政策检索
- 基于意图匹配政策
- 基于实体匹配政策
- 支持多政策组合匹配

#### 回答生成
- 生成结构化回答，包含肯定、否定和建议
- 支持政策叠加分析
- 提供个性化建议

### 4.3 API服务模块 ([main.py](file:///Users/tianyong/Documents/works/workspace/hp/公司文档/AI调研/政策咨询POC/code/serve_code/main.py))

#### API端点

##### 1. 对话接口（流式）
```
POST /api/chat/stream
```

**请求参数**：
```json
{
  "message": "用户问题",
  "scenario": "general | scenario1 | scenario2 | scenario3",
  "session_id": "可选，会话ID"
}
```

**响应数据**：
- SSE流式响应，包含会话信息、上下文数据和消息内容

##### 2. 对话接口（非流式）
```
POST /api/chat
```

**响应数据**：
```json
{
  "intent": {"intent": "意图描述", "entities": [...]},
  "relevant_policies": [...],
  "response": {"positive": "...", "negative": "...", "suggestions": "..."},
  "evaluation": {...},
  "execution_time": 3.45,
  "timing": {...},
  "llm_calls": [...]
}
```

##### 3. 政策列表接口
```
GET /api/policies
```

##### 4. 健康检查接口
```
GET /api/health
```

##### 5. 会话管理接口
```
GET /api/history
GET /api/history/{session_id}
DELETE /api/history/{session_id}
```

##### 6. 岗位管理接口
```
GET /api/jobs
GET /api/jobs/{job_id}
```

##### 7. 用户画像接口
```
GET /api/users/{user_id}/profile
POST /api/users/{user_id}/profile
```

##### 8. 推荐接口
```
GET /api/users/{user_id}/recommendations
GET /api/recommendations
```

### 4.4 前端模块 ([app.js](file:///Users/tianyong/Documents/works/workspace/hp/公司文档/AI调研/政策咨询POC/code/web_code/app.js))

#### 核心功能
1. **场景选择**：快速选择标准场景
2. **消息发送**：支持回车键和按钮发送
3. **历史管理**：管理对话历史记录
4. **结果展示**：结构化显示AI回复
5. **性能监控**：显示LLM调用时间和响应时间
6. **会话管理**：支持多会话切换和删除

#### API地址配置
```javascript
// API基础URL - 自动适配环境
const API_BASE_URL = (() => {
  // 检测当前环境
  const isLocal = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
  // 本地开发使用完整URL，部署后使用相对路径
  return isLocal ? 'http://localhost:8000/api' : '/api';
})();
```

## 5. 数据流

### 5.1 用户查询流程
```
用户输入问题
    ↓
前端发送请求到 /api/chat/stream
    ↓
API接收请求，开始计时
    ↓
PolicyAgent.process_query()
    ↓
检查缓存
    ↓
缓存未命中 → combined_process()
    ↓
┌─────────────────────────────────┐
│ 1. 意图识别 (LLM调用1)          │
│    - 生成提示词                  │
│    - 调用ChatBot.chat_with_memory()
│    - 解析JSON响应                │
│    - 记录调用时间                │
└─────────────────────────────────┘
    ↓
┌─────────────────────────────────┐
│ 2. 政策检索                      │
│    - 基于意图匹配                │
│    - 基于实体匹配                │
│    - 返回相关政策列表            │
└─────────────────────────────────┘
    ↓
┌─────────────────────────────────┐
│ 3. 回答生成 (LLM调用2)           │
│    - 简化政策格式                │
│    - 生成结构化提示词            │
│    - 调用ChatBot.chat_with_memory()
│    - 解析JSON响应                │
│    - 记录调用时间                │
└─────────────────────────────────┘
    ↓
┌─────────────────────────────────┐
│ 4. 结果评估                      │
│    - 评估回答质量                │
│    - 生成评估指标                │
└─────────────────────────────────┘
    ↓
┌─────────────────────────────────┐
│ 5. 缓存结果                      │
│    - 存储到内存缓存              │
│    - 限制缓存大小                │
└─────────────────────────────────┘
    ↓
通过SSE流式返回响应
    ↓
前端展示结果
```

## 6. 部署说明

### 6.1 环境要求
- Python 3.12+
- 现代浏览器（Chrome、Firefox、Safari、Edge）

### 6.2 本地开发部署

#### 1. 安装Python依赖
```bash
# 安装后端依赖
cd code/serve_code
pip install -r requirements.txt
```

#### 2. 配置环境变量
在项目根目录创建`.env`文件：
```
# LLM API配置
OPENAI_API_KEY=YOUR_API_KEY
OPENAI_API_BASE=https://ark.cn-beijing.volces.com/api/v3
LLM_MODEL=deepseek-v3-2-251201
LLM_TIMEOUT=1800
LLM_MAX_TOKENS=8192
```

#### 3. 启动后端服务
```bash
# 方式1：直接运行FastAPI
cd code/serve_code
python3 -m uvicorn main:app --host 0.0.0.0 --port 8000

# 方式2：从根目录运行（Vercel部署方式）
python3 -m uvicorn main:app --host 0.0.0.0 --port 8000
```

#### 4. 启动前端服务
```bash
cd code/web_code
python3 -m http.server 8080
```

#### 5. 访问应用
打开浏览器访问：http://localhost:8080

### 6.3 Vercel部署

#### 1. 配置Vercel环境变量
在Vercel控制台添加以下环境变量：
- OPENAI_API_KEY
- OPENAI_API_BASE
- LLM_MODEL
- LLM_TIMEOUT
- LLM_MAX_TOKENS

#### 2. 部署方式
- 通过GitHub仓库自动部署
- 使用Vercel CLI手动部署

#### 3. 部署配置
- vercel.json：配置构建规则和路由
- main.py：FastAPI入口点
- requirements.txt：根目录依赖

## 7. 配置说明

### 7.1 LLM配置
通过环境变量配置LLM参数：

| 环境变量 | 说明 | 默认值 |
|---------|------|--------|
| OPENAI_API_KEY | API密钥 | 必填 |
| OPENAI_API_BASE | API端点 | https://ark.cn-beijing.volces.com/api/v3 |
| LLM_MODEL | 模型名称 | deepseek-v3-2-251201 |
| LLM_TIMEOUT | 超时时间（秒） | 1800 |
| LLM_MAX_TOKENS | 最大令牌数 | 8192 |

### 7.2 应用配置
- **前端API地址**：自动适配环境，本地使用http://localhost:8000/api，部署后使用相对路径
- **CORS配置**：允许所有来源（生产环境建议限制）
- **缓存配置**：内存缓存，最多50条记录

## 8. 测试场景

### 8.1 场景一：创业扶持政策精准咨询
**用户输入**：
```
我是去年从广东回来的农民工，想在家开个小加工厂（小微企业），听说有返乡创业补贴，能领2万吗？另外创业贷款怎么申请？
```

**预期结果**：
- 识别意图：创业扶持政策咨询
- 识别实体：返乡农民工、小微企业
- 匹配政策：返乡创业扶持补贴政策、创业担保贷款贴息政策
- 生成结构化回答，包含符合条件的政策、申请条件和流程

### 8.2 场景二：技能培训岗位个性化推荐
**用户输入**：
```
请为一位32岁、失业、持有中级电工证的女性推荐工作，她关注补贴申领和灵活时间。
```

**预期结果**：
- 识别意图：技能培训推荐
- 识别实体：32岁、失业、中级电工证、女性
- 匹配政策：技能培训补贴政策
- 生成个性化推荐，包含补贴申领信息

### 8.3 场景三：多重政策叠加咨询
**用户输入**：
```
我是退役军人，开汽车维修店（个体），同时入驻创业孵化基地（年租金8000元），能同时享受税收优惠和场地补贴吗？
```

**预期结果**：
- 识别意图：多重政策叠加咨询
- 识别实体：退役军人、个体经营、创业孵化基地、年租金8000元
- 匹配政策：退役军人创业税收优惠政策、创业场地租金补贴政策
- 分析政策叠加可能性，提供综合建议

### 8.4 场景四：培训课程智能匹配
**用户输入**：
```
我今年38岁，之前在工厂做机械操作工，现在失业了，只有初中毕业证，想转行做电商运营，不知道该报什么培训课程？另外，失业人员参加培训有补贴吗？
```

**预期结果**：
- 识别意图：培训课程智能匹配
- 识别实体：38岁、失业、初中毕业证、电商运营
- 匹配政策：职业技能提升补贴政策
- 匹配课程：电商运营基础课程、电商平台操作实务
- 生成课程+补贴打包方案和成长路径

## 9. 故障排查

### 9.1 常见问题

#### 问题1：前端无法连接后端
**原因**：
- 后端服务未启动
- 端口冲突
- CORS配置问题

**解决**：
- 检查后端服务是否正常运行
- 检查端口是否被占用
- 确认CORS配置是否允许前端域名

#### 问题2：LLM调用超时
**原因**：
- 网络问题
- API响应慢
- 提示词过长

**解决**：
- 检查网络连接
- 增加timeout参数
- 优化提示词长度
- 减少历史消息数量

#### 问题3：缓存不生效
**原因**：
- 缓存键冲突
- 缓存已满
- 缓存未正确实现

**解决**：
- 检查缓存键生成逻辑
- 清空缓存重试
- 增加缓存大小限制

#### 问题4：422 Unprocessable Entity错误
**原因**：
- 请求参数类型不正确
- 缺少必填参数

**解决**：
- 确保请求参数类型正确
- 检查是否缺少必填参数
- 查看API文档确认参数格式

## 10. 性能优化

### 10.1 LLM调用优化
| 优化措施 | 效果 |
|---------|------|
| 降低temperature参数 | 减少模型思考时间 |
| 限制max_tokens | 减少生成时间 |
| 简化消息格式 | 减少上下文长度 |
| 输入截断处理 | 避免超长输入 |
| 历史消息限制 | 控制上下文大小 |

### 10.2 缓存优化
- **内存缓存**：使用Python字典存储
- **LRU策略**：自动清理最久未使用的缓存
- **大小限制**：最多50条缓存
- **缓存键**：基于用户输入的哈希

### 10.3 响应时间分析
| 操作 | 平均耗时 | 优化后耗时 |
|------|---------|-----------|
| 意图识别 | 2.0秒 | 1.5秒 |
| 政策检索 | 0.1秒 | 0.1秒 |
| 回答生成 | 2.5秒 | 1.7秒 |
| 结果评估 | 0.3秒 | 0.25秒 |
| 总计 | 4.9秒 | 3.55秒 |
| 缓存命中 | - | <0.01秒 |

## 11. 未来优化方向

### 11.1 功能优化
1. **多轮对话**：增强对话记忆，支持上下文理解
2. **知识图谱**：构建政策知识图谱，提升检索精度
3. **个性化推荐**：基于用户画像提供个性化政策推荐
4. **多模态交互**：支持语音、图片等多模态输入
5. **政策时效性管理**：自动更新政策数据

### 11.2 性能优化
1. **异步处理**：使用异步IO提升并发性能
2. **批处理**：支持批量政策查询
3. **分布式缓存**：使用Redis集群提升缓存性能
4. **模型量化**：使用量化模型减少推理时间
5. **负载均衡**：支持多实例部署

### 11.3 安全优化
1. **输入验证**：增强输入验证和过滤
2. **速率限制**：实现API速率限制
3. **审计日志**：记录所有操作日志
4. **数据加密**：敏感数据加密存储
5. **API密钥管理**：使用密钥管理服务

## 12. 附录

### 12.1 政策数据示例
```json
{
  "policy_id": "POLICY_A01",
  "title": "创业担保贷款贴息政策",
  "category": "创业扶持",
  "conditions": [
    {"type": "身份", "value": "返乡农民工"},
    {"type": "贷款额度", "value": "≤50万"},
    {"type": "贷款期限", "value": "≤3年"}
  ],
  "benefits": [
    {"type": "贴息", "value": "LPR-150BP以上部分财政贴息"}
  ],
  "application_path": "XX人社局官网-创业服务专栏"
}
```

### 12.2 Vercel部署入口示例
```python
# Vercel FastAPI 入口点
# 导入现有FastAPI应用
import sys
import os

# 添加项目根目录到路径
sys.path.insert(0, os.path.abspath('.'))

# 从现有位置导入app实例
from code.serve_code.main import app

# 暴露app实例，供Vercel使用
__all__ = ['app']
```

### 12.3 技术参考文档
- [FastAPI官方文档](https://fastapi.tiangolo.com/)
- [LangChain官方文档](https://python.langchain.com/)
- [火山引擎API文档](https://www.volcengine.com/docs)
- [OpenAI API文档](https://platform.openai.com/docs)

---

**文档版本**：v1.3  
**最后更新**：2026-01-27  
**维护者**：政策咨询智能体POC团队